---
import Button from '../../components/Button.astro';
import Card from '../../components/Card.astro';
import Layout from '../../layouts/Layout.astro';
import {
  BLOG_POSTS_PER_PAGE,
  getArchiveSummary,
  getPageItems,
  getPublishedPosts,
  getTagSummary,
  getTotalPages,
  slugifyTag,
} from '../../lib/content';

const posts = await getPublishedPosts();
const pagePosts = getPageItems(posts, 1, BLOG_POSTS_PER_PAGE);
const totalPages = getTotalPages(posts.length, BLOG_POSTS_PER_PAGE);
const tags = getTagSummary(posts);
const archive = getArchiveSummary(posts);
---

<Layout title="Team Orchestrator Blog" description="Updates, product thinking, and mission reports.">
  <section class="page-header">
    <div class="container">
      <p class="eyebrow">Blog</p>
      <h1>Mission reports and product updates</h1>
      <p class="lead">Stories from building managed autonomy for engineering teams.</p>
    </div>
  </section>

  <section class="section">
    <div class="container split">
      <Card>
        <h2>Tags</h2>
        <ul class="link-list">
          {tags.map((tag) => (
            <li>
              <a href={`/blog/tags/${tag.slug}/`}>{tag.tag}</a>
              <span class="meta"> ({tag.count})</span>
            </li>
          ))}
        </ul>
        <p><Button href="/blog/tags" variant="secondary">View all tags</Button></p>
      </Card>
      <Card>
        <h2>Archive</h2>
        <ul class="link-list">
          {archive.map((entry) => (
            <li>
              <a href={`/blog/archive/${entry.year}/`}>{entry.year}</a>
              <span class="meta"> ({entry.count})</span>
            </li>
          ))}
        </ul>
        <p><Button href="/blog/archive" variant="secondary">View full archive</Button></p>
      </Card>
    </div>
  </section>

  <section class="section">
    <div class="container post-grid">
      {pagePosts.map((post) => (
        <Card>
          <h2><a href={`/blog/${post.slug}/`}>{post.data.title}</a></h2>
          <p>{post.data.description}</p>
          <p class="meta">{post.data.pubDate.toLocaleDateString()}</p>
          <p class="meta">
            {post.data.tags.map((tag, index) => (
              <>
                {index > 0 && ' Â· '}
                <a href={`/blog/tags/${slugifyTag(tag)}/`}>{tag}</a>
              </>
            ))}
          </p>
        </Card>
      ))}
    </div>
    {totalPages > 1 && (
      <div class="container">
        <nav class="pagination" aria-label="Blog pagination">
          <span class="meta">Page 1 of {totalPages}</span>
          <ul>
            <li><span aria-current="page">1</span></li>
            {Array.from({ length: totalPages - 1 }, (_, index) => {
              const pageNumber = index + 2;
              return (
                <li>
                  <a href={`/blog/page/${pageNumber}/`}>{pageNumber}</a>
                </li>
              );
            })}
          </ul>
        </nav>
      </div>
    )}
  </section>
</Layout>
