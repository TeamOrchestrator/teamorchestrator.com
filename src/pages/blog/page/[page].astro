---
import Layout from '../../../layouts/Layout.astro';
import {
  BLOG_POSTS_PER_PAGE,
  getArchiveSummary,
  getPageItems,
  getPublishedPosts,
  getTagSummary,
  getTotalPages,
  slugifyTag,
} from '../../../lib/content';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  const totalPages = getTotalPages(posts.length, BLOG_POSTS_PER_PAGE);

  return Array.from({ length: Math.max(0, totalPages - 1) }, (_, index) => {
    const pageNumber = index + 2;
    return {
      params: { page: String(pageNumber) },
      props: { pageNumber, totalPages },
    };
  });
}

interface Props {
  pageNumber: number;
  totalPages: number;
}

const { pageNumber, totalPages } = Astro.props as Props;
const posts = await getPublishedPosts();
const pagePosts = getPageItems(posts, pageNumber, BLOG_POSTS_PER_PAGE);
const tags = getTagSummary(posts);
const archive = getArchiveSummary(posts);
---

<Layout title={`Team Orchestrator Blog | Page ${pageNumber}`} description="Updates, product thinking, and mission reports.">
  <section class="page-header">
    <div class="container">
      <p class="eyebrow">Blog</p>
      <h1>Mission reports and product updates</h1>
      <p class="lead">Stories from building managed autonomy for engineering teams.</p>
    </div>
  </section>

  <section class="section">
    <div class="container split">
      <article class="card">
        <h2>Tags</h2>
        <ul class="link-list">
          {tags.map((tag) => (
            <li>
              <a href={`/blog/tags/${tag.slug}/`}>{tag.tag}</a>
              <span class="meta"> ({tag.count})</span>
            </li>
          ))}
        </ul>
        <p><a href="/blog/tags">View all tags</a></p>
      </article>
      <article class="card">
        <h2>Archive</h2>
        <ul class="link-list">
          {archive.map((entry) => (
            <li>
              <a href={`/blog/archive/${entry.year}/`}>{entry.year}</a>
              <span class="meta"> ({entry.count})</span>
            </li>
          ))}
        </ul>
        <p><a href="/blog/archive">View full archive</a></p>
      </article>
    </div>
  </section>

  <section class="section">
    <div class="container post-grid">
      {pagePosts.map((post) => (
        <article class="card">
          <h2><a href={`/blog/${post.slug}/`}>{post.data.title}</a></h2>
          <p>{post.data.description}</p>
          <p class="meta">{post.data.pubDate.toLocaleDateString()}</p>
          <p class="meta">
            {post.data.tags.map((tag, index) => (
              <>
                {index > 0 && ' Â· '}
                <a href={`/blog/tags/${slugifyTag(tag)}/`}>{tag}</a>
              </>
            ))}
          </p>
        </article>
      ))}
    </div>
    <div class="container">
      <nav class="pagination" aria-label="Blog pagination">
        <span class="meta">Page {pageNumber} of {totalPages}</span>
        <ul>
          {Array.from({ length: totalPages }, (_, index) => {
            const target = index + 1;
            const href = target === 1 ? '/blog/' : `/blog/page/${target}/`;
            return (
              <li>
                {target === pageNumber ? (
                  <span aria-current="page">{target}</span>
                ) : (
                  <a href={href}>{target}</a>
                )}
              </li>
            );
          })}
        </ul>
      </nav>
    </div>
  </section>
</Layout>