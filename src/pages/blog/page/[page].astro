---
import Button from '../../../components/Button.astro';
import Card from '../../../components/Card.astro';
import Layout from '../../../layouts/Layout.astro';
import {
  BLOG_POSTS_PER_PAGE,
  getArchiveSummary,
  getPageItems,
  getPublishedPosts,
  getTagSummary,
  getTotalPages,
  slugifyTag,
} from '../../../lib/content';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  const totalPages = getTotalPages(posts.length, BLOG_POSTS_PER_PAGE);

  return Array.from({ length: Math.max(0, totalPages - 1) }, (_, index) => {
    const pageNumber = index + 2;
    return {
      params: { page: String(pageNumber) },
      props: { pageNumber, totalPages },
    };
  });
}

interface Props {
  pageNumber: number;
  totalPages: number;
}

const { pageNumber, totalPages } = Astro.props as Props;
const posts = await getPublishedPosts();
const pagePosts = getPageItems(posts, pageNumber, BLOG_POSTS_PER_PAGE);
const tags = getTagSummary(posts);
const archive = getArchiveSummary(posts);
---

<Layout title={`Team Orchestrator Blog | Page ${pageNumber}`} description="Updates, product thinking, and mission reports.">
  <section class="page-header">
    <div class="container">
      <p class="eyebrow">Blog</p>
      <h1>Mission reports and product updates</h1>
      <p class="lead">Stories from building managed autonomy for engineering teams.</p>
    </div>
  </section>

  <section class="section">
    <div class="container split">
      <Card>
        <h2>Tags</h2>
        <ul class="link-list">
          {tags.map((tag) => (
            <li>
              <a
                href={`/blog/tags/${tag.slug}/`}
                data-analytics-event="blog_tag_click"
                data-analytics-category="blog"
                data-analytics-label={tag.slug}
                data-analytics-location="blog_page_tags_card"
              >
                {tag.tag}
              </a>
              <span class="meta"> ({tag.count})</span>
            </li>
          ))}
        </ul>
        <p>
          <Button
            href="/blog/tags"
            variant="secondary"
            analyticsEvent="blog_navigation_click"
            analyticsCategory="blog"
            analyticsLabel="view_all_tags"
            analyticsLocation="blog_page_tags_card"
          >
            View all tags
          </Button>
        </p>
      </Card>
      <Card>
        <h2>Archive</h2>
        <ul class="link-list">
          {archive.map((entry) => (
            <li>
              <a
                href={`/blog/archive/${entry.year}/`}
                data-analytics-event="blog_archive_click"
                data-analytics-category="blog"
                data-analytics-label={entry.year}
                data-analytics-location="blog_page_archive_card"
              >
                {entry.year}
              </a>
              <span class="meta"> ({entry.count})</span>
            </li>
          ))}
        </ul>
        <p>
          <Button
            href="/blog/archive"
            variant="secondary"
            analyticsEvent="blog_navigation_click"
            analyticsCategory="blog"
            analyticsLabel="view_full_archive"
            analyticsLocation="blog_page_archive_card"
          >
            View full archive
          </Button>
        </p>
      </Card>
    </div>
  </section>

  <section class="section">
    <div class="container post-grid">
      {pagePosts.map((post) => (
        <Card>
          <h2>
            <a
              href={`/blog/${post.slug}/`}
              data-analytics-event="blog_post_click"
              data-analytics-category="blog"
              data-analytics-label={post.slug}
              data-analytics-location="blog_page_post_grid"
            >
              {post.data.title}
            </a>
          </h2>
          <p>{post.data.description}</p>
          <p class="meta">{post.data.pubDate.toLocaleDateString()}</p>
          <p class="meta">
            {post.data.tags.map((tag, index) => (
              <>
                {index > 0 && ' Â· '}
                <a
                  href={`/blog/tags/${slugifyTag(tag)}/`}
                  data-analytics-event="blog_tag_click"
                  data-analytics-category="blog"
                  data-analytics-label={slugifyTag(tag)}
                  data-analytics-location="blog_page_post_grid"
                >
                  {tag}
                </a>
              </>
            ))}
          </p>
        </Card>
      ))}
    </div>
    <div class="container">
      <nav class="pagination" aria-label="Blog pagination">
        <span class="meta">Page {pageNumber} of {totalPages}</span>
        <ul>
          {Array.from({ length: totalPages }, (_, index) => {
            const target = index + 1;
            const href = target === 1 ? '/blog/' : `/blog/page/${target}/`;
            return (
              <li>
                {target === pageNumber ? (
                  <span aria-current="page">{target}</span>
                ) : (
                  <a
                    href={href}
                    data-analytics-event="blog_pagination_click"
                    data-analytics-category="blog"
                    data-analytics-label={`page_${target}`}
                    data-analytics-location="blog_page_pagination"
                  >
                    {target}
                  </a>
                )}
              </li>
            );
          })}
        </ul>
      </nav>
    </div>
  </section>
</Layout>
