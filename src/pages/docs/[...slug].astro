---
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { getDocsSections, getSortedDocs } from '../../lib/content';

export async function getStaticPaths() {
  const docs = await getSortedDocs();

  return docs.map((doc) => ({
    params: { slug: doc.slug },
    props: { doc },
  }));
}

interface Props {
  doc: CollectionEntry<'docs'>;
}

const { doc } = Astro.props;
const { Content, headings } = await doc.render();
const pageHeadings = headings.filter((heading) => heading.depth >= 2 && heading.depth <= 3);
const allDocs = await getSortedDocs();
const sections = getDocsSections(allDocs);
---

<Layout title={`${doc.data.title} | Team Orchestrator Docs`} description={doc.data.description}>
  <section class="page-header">
    <div class="container">
      <p class="eyebrow">Documentation</p>
      <h1>{doc.data.title}</h1>
      <p class="lead compact">{doc.data.description}</p>
    </div>
  </section>

  <section class="content">
    <div class="container docs-layout">
      <aside class="docs-sidebar card">
        <h2>Documentation</h2>
        {sections.map((section) => (
          <section>
            <h3>{section.section}</h3>
            <ul>
              {section.docs.map((sectionDoc) => (
                <li>
                  <a
                    class={sectionDoc.slug === doc.slug ? 'active' : undefined}
                    href={`/docs/${sectionDoc.slug}/`}
                  >
                    {sectionDoc.data.title}
                  </a>
                </li>
              ))}
            </ul>
          </section>
        ))}
        {pageHeadings.length > 0 && (
          <section>
            <h3>On this page</h3>
            <ul>
              {pageHeadings.map((heading) => (
                <li>
                  <a class={`toc-link depth-${heading.depth}`} href={`#${heading.slug}`}>
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </section>
        )}
      </aside>
      <article>
        <Content />
      </article>
    </div>
  </section>
</Layout>